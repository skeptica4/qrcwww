-- =================================================================
-- CONFIGURATION
-- =================================================================

---
-- Number of shots to fire at each target per burst cycle
---
local SHOTS_PER_TARGET = 150

---
-- Cooldown BETWEEN complete burst cycles
---
local BURST_COOLDOWN = 0.1

-- =================================================================
-- SERVICES AND CORE VARIABLES
-- =================================================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Weapon list
local VALID_WEAPONS = {
    "Akimbo", "Voltaic Impact", "Gunslingers", "Burst Rifle", "Stonewall",
    "Steelforge", "DMR", "Gift of Fire", "Armour Peeler", "Medical Bow",
    "Recurve", "Vitabow", "Rifle", "Bolter", "Harpoon Gun", "RPG",
    "Rocket Stormer", "Shockwave Device", "Shotgun", "Hallsweeper",
    "Sprinter's Streak", "SMG", "Loose Trigger", "Twinface",
    "Mastermind's Rifle", "Shovel", "Overcharger", "Rallying Cry",
    "Machete", "Handaxes", "Torqueblade"
}

-- NPCs to ignore
local EXCLUDED = {
    Landmine=1, Man=1, Turret=1, Stonehedge=1, Sprayer=1, 
    Sentinel=1, Refugee=1, PDC=1, MADS=1, Lifeline=1, 
    Hallucinator=1, Governor=1, FAST_point=1, Barrier=1, 
    Administrator=1
}
for i = 1, 11 do EXCLUDED["dead guy " .. i] = 1 end

-- Convert weapon list to lookup table
local weaponLookup = {}
for _, name in ipairs(VALID_WEAPONS) do
    weaponLookup[name] = true
end

-- =================================================================
-- HELPER FUNCTIONS
-- =================================================================

-- Get current held weapon
local function getCurrentWeapon()
    local char = LocalPlayer.Character
    if not char then return nil, nil end
    
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and weaponLookup[tool.Name] then
            local verifyHit = tool:FindFirstChild("VerifyHit")
            if verifyHit and verifyHit:IsA("RemoteEvent") then
                return tool, verifyHit
            end
        end
    end
    
    return nil, nil
end

-- Handle Platform special logic
local function handlePlatform(platform, targets)
    local livingEmplacements = {}
    local allEmplacementsDead = true
    
    -- Step 1: Check ALL Emplacements
    for _, child in ipairs(platform:GetChildren()) do
        if child.Name:match("Emplacement%d") then
            local humanoid = child:FindFirstChildOfClass("Humanoid")
            if humanoid then
                if humanoid.Health > 0 then
                    allEmplacementsDead = false
                    table.insert(livingEmplacements, {
                        humanoid = humanoid,
                        model = child,
                        parent = platform
                    })
                end
            end
        end
    end
    
    -- Step 2: Decide what to target
    if not allEmplacementsDead then
        for _, emplacement in ipairs(livingEmplacements) do
            table.insert(targets, emplacement)
        end
    else
        local platformHumanoid = platform:FindFirstChildOfClass("Humanoid")
        if platformHumanoid and platformHumanoid.Health > 0 then
            table.insert(targets, {
                humanoid = platformHumanoid,
                model = platform,
                parent = platform
            })
        end
    end
end

-- Find all valid targets in workspace
local function findTargets()
    local targets = {}
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return targets 
    end
    
    for _, obj in ipairs(workspace:GetChildren()) do
        if obj:IsA("Model") and not EXCLUDED[obj.Name] and not Players:GetPlayerFromCharacter(obj) then
            
            if obj.Name == "Tank" then
                for _, child in ipairs(obj:GetChildren()) do
                    if child.Name == "PropaneTank" then
                        local humanoid = child:FindFirstChildOfClass("Humanoid")
                        if humanoid and humanoid.Health > 0 then
                            table.insert(targets, {
                                humanoid = humanoid, 
                                model = child,
                                parent = obj
                            })
                        end
                    end
                end
                
            elseif obj.Name == "Platform" then
                handlePlatform(obj, targets)
                
            elseif obj.Name == "APU" then
                local pilot = obj:FindFirstChild("Pilot")
                if pilot then
                    local humanoid = pilot:FindFirstChildOfClass("Humanoid")
                    if humanoid and humanoid.Health > 0 then
                        table.insert(targets, {
                            humanoid = humanoid, 
                            model = pilot,
                            parent = obj
                        })
                    end
                end
                
            else
                local humanoid = obj:FindFirstChildOfClass("Humanoid")
                if humanoid and humanoid.Health > 0 then
                    table.insert(targets, {
                        humanoid = humanoid, 
                        model = obj,
                        parent = obj
                    })
                end
            end
        end
    end
    
    return targets
end

-- Prepare target data with parts and positions
local function prepareTargetData(targets)
    local targetData = {}
    
    for _, target in ipairs(targets) do
        if target.humanoid.Parent and target.humanoid.Health > 0 then
            -- Get parts to shoot at
            local parts = {}
            for _, part in ipairs(target.model:GetDescendants()) do
                if part:IsA("BasePart") and #parts < 5 then
                    table.insert(parts, part)
                end
            end
            
            if #parts == 0 and target.parent then
                for _, part in ipairs(target.parent:GetDescendants()) do
                    if part:IsA("BasePart") and #parts < 5 then
                        table.insert(parts, part)
                    end
                end
            end
            
            if #parts == 0 then
                parts = {{Position = target.model:GetPivot().Position}}
            end
            
            table.insert(targetData, {
                humanoid = target.humanoid,
                parts = parts
            })
        end
    end
    
    return targetData
end

-- =================================================================
-- SIMULTANEOUS BURST ATTACK FUNCTION
-- =================================================================

---
-- This function fires multiple shots at ALL targets simultaneously
-- Each target gets hit SHOTS_PER_TARGET times, but all targets
-- are being hit at the same time in a synchronized manner
---
local function executeSimultaneousBurst(targets, remote)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    local shooterPos = char.HumanoidRootPart.Position
    
    -- Prepare all target data upfront
    local targetData = prepareTargetData(targets)
    if #targetData == 0 then return end
    
    -- Fire SHOTS_PER_TARGET shots, but cycle through ALL targets each iteration
    -- This creates true simultaneous sustained fire on all targets
    for shot = 1, SHOTS_PER_TARGET do
        for _, data in ipairs(targetData) do
            if data.humanoid.Parent and data.humanoid.Health > 0 then
                -- Select random part and add randomized offset
                local part = data.parts[math.random(1, #data.parts)]
                local hitPos = part.Position + Vector3.new(
                    math.random() * 0.5 - 0.25,
                    math.random() * 0.5 - 0.25,
                    math.random() * 0.5 - 0.25
                )
                
                -- Fire the remote
                pcall(function()
                    remote:FireServer(data.humanoid, hitPos, shooterPos)
                end)
            end
        end
        -- NO WAIT - all targets hit before moving to next shot iteration
    end
end

-- =================================================================
-- MAIN LOOP
-- =================================================================

while true do
    local weapon, remote = getCurrentWeapon()
    
    if weapon and remote then
        local targets = findTargets()
        if #targets > 0 then
            -- Execute simultaneous burst on ALL targets
            executeSimultaneousBurst(targets, remote)
            
            -- Wait after completing the full burst cycle
            task.wait(BURST_COOLDOWN)
        else
            task.wait(0.2)
        end
    else
        task.wait(0.5)
    end
end
