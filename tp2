local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Raw lookup tables for performance and brevity
local WEAPONS = { Akimbo=1, ["Voltaic Impact"]=1, Gunslingers=1, ["Burst Rifle"]=1, Stonewall=1, Steelforge=1, DMR=1, ["Gift of Fire"]=1, ["Armour Peeler"]=1, ["Medical Bow"]=1, Recurve=1, Vitabow=1, Rifle=1, Bolter=1, ["Harpoon Gun"]=1, RPG=1, ["Rocket Stormer"]=1, ["Shockwave Device"]=1, Shotgun=1, Hallsweeper=1, ["Sprinter's Streak"]=1, SMG=1, ["Loose Trigger"]=1, Twinface=1, ["Mastermind's Rifle"]=1, Shovel=1, Overcharger=1, ["Rallying Cry"]=1, Machete=1, Handaxes=1, Torqueblade=1 }
local EXCLUDED = { Landmine=1, Man=1, Turret=1, Stonehedge=1, Sprayer=1, Sentinel=1, Refugee=1, PDC=1, MADS=1, Lifeline=1, Hallucinator=1, Governor=1, FAST_point=1, Barrier=1, Administrator=1 }
for i=1,11 do EXCLUDED["dead guy "..i]=1 end

local shooting = {}

-- Data-driven functions for handling special target types
local TARGET_HANDLERS = {
	Tank = function(model, targets)
		for _, child in ipairs(model:GetChildren()) do
			if child.Name == "PropaneTank" then
				local humanoid = child:FindFirstChildOfClass("Humanoid")
				if humanoid and humanoid.Health > 0 then table.insert(targets, {humanoid=humanoid, model=child, parent=model}) end
			end
		end
	end,
	Platform = function(model, targets)
		local livingEmplacements = {}
		for _, child in ipairs(model:GetChildren()) do
			if child.Name:match("Emplacement%d") then
				local humanoid = child:FindFirstChildOfClass("Humanoid")
				if humanoid and humanoid.Health > 0 then table.insert(livingEmplacements, {humanoid=humanoid, model=child, parent=model}) end
			end
		end

		if #livingEmplacements > 0 then
			for _, emp in ipairs(livingEmplacements) do table.insert(targets, emp) end
		else
			local humanoid = model:FindFirstChildOfClass("Humanoid")
			if humanoid and humanoid.Health > 0 then table.insert(targets, {humanoid=humanoid, model=model, parent=model}) end
		end
	end,
	APU = function(model, targets)
		local pilot = model:FindFirstChild("Pilot")
		if pilot then
			local humanoid = pilot:FindFirstChildOfClass("Humanoid")
			if humanoid and humanoid.Health > 0 then table.insert(targets, {humanoid=humanoid, model=pilot, parent=model}) end
		end
	end,
}

local function getWeapon()
	local char = LocalPlayer.Character
	if not char then return nil, nil end
	for _, tool in ipairs(char:GetChildren()) do
		if tool:IsA("Tool") and WEAPONS[tool.Name] then
			local remote = tool:FindFirstChild("VerifyHit")
			if remote and remote:IsA("RemoteEvent") then return tool, remote end
		end
	end
	return nil, nil
end

local function findTargets()
	local targets = {}
	if not LocalPlayer.Character then return targets end

	for _, obj in ipairs(workspace:GetChildren()) do
		if obj:IsA("Model") and not EXCLUDED[obj.Name] and not Players:GetPlayerFromCharacter(obj) then
			local handler = TARGET_HANDLERS[obj.Name]
			if handler then
				handler(obj, targets)
			else -- Default handler for all other models
				local humanoid = obj:FindFirstChildOfClass("Humanoid")
				if humanoid and humanoid.Health > 0 then table.insert(targets, {humanoid=humanoid, model=obj, parent=obj}) end
			end
		end
	end
	return targets
end

local function killTarget(target, remote)
	if shooting[target.humanoid] then return end
	shooting[target.humanoid] = true

	task.spawn(function()
		local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if not root then shooting[target.humanoid] = nil; return end

		local parts = {}
		for _, p in ipairs(target.model:GetDescendants()) do if p:IsA("BasePart") then table.insert(parts, p) end if #parts>=5 then break end end
		if #parts==0 and target.parent then for _, p in ipairs(target.parent:GetDescendants()) do if p:IsA("BasePart") then table.insert(parts, p) end if #parts>=5 then break end end
		if #parts==0 then parts = {{Position = target.model:GetPivot().Position}} end

		local shots = 0
		while target.humanoid and target.humanoid.Parent and target.humanoid.Health > 0 and shots < 150 do
			shots += 1
			local part = parts[math.random(#parts)]
			local hitPos = part.Position + Vector3.new(math.random()-.5, math.random()-.5, math.random()-.5)
			
			-- Spoof shooter position to bypass distance/LoS checks
			local spoofedPos = hitPos + (root.Position - hitPos).Unit * 10

			pcall(remote.FireServer, remote, target.humanoid, hitPos, spoofedPos)
			task.wait()
		end
		shooting[target.humanoid] = nil
	end)
end

-- Main Loop
task.spawn(function()
	while task.wait(0.1) do
		for humanoid in pairs(shooting) do
			if not humanoid or not humanoid.Parent or humanoid.Health <= 0 then shooting[humanoid] = nil end
		end

		local _, remote = getWeapon()
		if remote then
			for _, target in ipairs(findTargets()) do
				killTarget(target, remote)
				task.wait(0.01)
			end
		end
	end
end)
