_G.killaura = { enabled = true }

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local EXCLUDED = {["Landmine"]=true,["Man"]=true,["Turret"]=true,["Stonehedge"]=true,["Sprayer"]=true,["Sentinel"]=true,["Refugee"]=true,["PDC"]=true,["MADS"]=true,["Lifeline"]=true,["Hallucinator"]=true,["Governor"]=true,["FAST_point"]=true,["Barrier"]=true,["Administrator"]=true}
for i=1,11 do EXCLUDED["dead guy "..i]=true end

local weapon, lastScan, uuid = nil, 0, 0

local function findWeapon()
	local char = LocalPlayer.Character
	if not char then return end
	
	for _, item in ipairs(char:GetChildren()) do
		if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") and item:FindFirstChild("VerifyHit") then return item end
	end
	for _, item in ipairs(LocalPlayer.Backpack:GetChildren()) do
		if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") and item:FindFirstChild("VerifyHit") then return item end
	end
end

RunService.Heartbeat:Connect(function()
	if not _G.killaura.enabled then return end
	
	local now = tick()
	if now - lastScan < 0.25 then return end
	lastScan = now

	if not weapon or not weapon.Parent then weapon = findWeapon() end
	if not weapon or not LocalPlayer.Character then return end
	
	local verifyHit = weapon.VerifyHit
	local targets, priority = {}, {}

	for _, model in ipairs(workspace:GetChildren()) do
		if model:IsA("Model") and model ~= LocalPlayer.Character and not EXCLUDED[model.Name] then
			local hum = model:FindFirstChildOfClass("Humanoid")
			if hum and hum.Health > 0 then
				if model.Name == "Drone" then table.insert(priority, hum) else table.insert(targets, hum) end
			elseif model.Name == "Platform" then
				local hasLive = false
				for _, child in ipairs(model:GetChildren()) do
					if string.match(child.Name, "Emplacement%d") then
						local emp = child:FindFirstChildOfClass("Humanoid")
						if emp and emp.Health > 0 then hasLive, _ = table.insert(targets, emp), true end
					end
				end
				if not hasLive and hum and hum.Health > 0 then table.insert(targets, hum) end
			elseif model.Name == "APU" then
				local pilot = model:FindFirstChild("Pilot")
				local pilotHum = pilot and pilot:FindFirstChildOfClass("Humanoid")
				if pilotHum and pilotHum.Health > 0 then table.insert(targets, pilotHum) end
			end
		end
	end

	table.move(targets, 1, #targets, #priority + 1, priority)
	for i = 1, #priority do
		uuid += 1
		task.spawn(verifyHit.FireServer, verifyHit, priority[i], "v-"..uuid)
	end
end)
