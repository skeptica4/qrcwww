local Players = game:GetService("Players")
local plr = Players.LocalPlayer
local weaponCache = nil

local EXCLUDED = {
	Landmine=true, Man=true, Turret=true, Stonehedge=true, Sprayer=true, Sentinel=true,
	Refugee=true, PDC=true, MADS=true, Lifeline=true, Hallucinator=true, Governor=true,
	FAST_point=true, Barrier=true, Administrator=true, ["dead guy 1"]=true, ["dead guy 2"]=true,
	["dead guy 3"]=true, ["dead guy 4"]=true, ["dead guy 5"]=true, ["dead guy 6"]=true,
	["dead guy 7"]=true, ["dead guy 8"]=true, ["dead guy 9"]=true, ["dead guy 10"]=true, ["dead guy 11"]=true,
}

local function attack(target)
	if not weaponCache or not weaponCache.Parent then
		weaponCache = nil
		local char = plr.Character
		if not char then return end

		for _, item in ipairs(char:GetChildren()) do
			if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") then
				weaponCache = item; break
			end
		end

		if not weaponCache then
			for _, item in ipairs(plr.Backpack:GetChildren()) do
				if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") then
					weaponCache = item; break
				end
			end
		end
		
		if not weaponCache then return end
	end
	
	pcall(weaponCache.VerifyHit.FireServer, weaponCache.VerifyHit, target, math.random())
end

local function getTarget(model)
	if model.Name == "APU" then
		-- Handle old structure (Humanoid inside a "Pilot" part)
		local pilot = model:FindFirstChild("Pilot")
		if pilot then
			local hum = pilot:FindFirstChildOfClass("Humanoid")
			if hum then return hum end
		end
		-- If old structure not found, fall through to generic check for new structure
	end
	
	if model.Name == "Tank" then
		for _, child in ipairs(model:GetChildren()) do
			if child.Name == "PropaneTank" then
				local hum = child:FindFirstChildOfClass("Humanoid")
				if hum and hum.Health > 0 then return hum end
			end
		end
	end

	if model.Name == "Platform" then
		for _, child in ipairs(model:GetChildren()) do
			if child.Name:match("Emplacement") then
				local hum = child:FindFirstChildOfClass("Humanoid")
				if hum and hum.Health > 0 then return hum end
			end
		end
	end
	
	-- Generic fallback (also handles the new APU structure)
	return model:FindFirstChildOfClass("Humanoid")
end

task.spawn(function()
	while task.wait(0.05) do
		for _, model in ipairs(workspace:GetChildren()) do
			if model:IsA("Model") and not EXCLUDED[model.Name] and not Players:GetPlayerFromCharacter(model) then
				local target = getTarget(model)
				if target and target.Health > 0 then
					task.spawn(attack, target)
				end
			end
		end
	end
end)
