local Aura = {
	Enabled = false,
}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local EXCLUDED_NAMES = {
	Landmine=true, Man=true, Turret=true, Stonehedge=true, Sprayer=true, Sentinel=true, Refugee=true, PDC=true,
	MADS=true, Lifeline=true, Hallucinator=true, Governor=true, FAST_point=true, Barrier=true, Administrator=true,
	["dead guy 1"]=true, ["dead guy 2"]=true, ["dead guy 3"]=true, ["dead guy 4"]=true, ["dead guy 5"]=true, ["dead guy 6"]=true,
	["dead guy 7"]=true, ["dead guy 8"]=true, ["dead guy 9"]=true, ["dead guy 10"]=true, ["dead guy 11"]=true
}
local NPC_RELATIONSHIPS = {
	Drone = { protects = "Achilles" }
}

local weaponCache
local npcCache = {}
local lastCacheTime = 0

local function findMeleeWeapon()
	local localPlayer = Players.LocalPlayer
	local character = localPlayer and localPlayer.Character
	if not character then return end

	for _, item in ipairs(character:GetChildren()) do
		if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") and item:FindFirstChild("VerifyHit") then
			return item
		end
	end
end

local function findValidNPCs()
	local validNpcs, priorityTargets = {}, {}
	local workspaceChildren = Workspace:GetChildren()

	for _, model in ipairs(workspaceChildren) do
		if model:IsA("Model") and not EXCLUDED_NAMES[model.Name] and not Players:GetPlayerFromCharacter(model) then
			local target = model:FindFirstChildOfClass("Humanoid")
			if model.Name == "Platform" then
				local emplacementsAlive = false
				for _, child in ipairs(model:GetChildren()) do
					if string.match(child.Name, "Emplacement%d") then
						local empTarget = child:FindFirstChildOfClass("Humanoid")
						if empTarget and empTarget.Health > 0 then
							emplacementsAlive = true
							table.insert(validNpcs, empTarget)
						end
					end
				end
				if emplacementsAlive then continue end
			end

			if target and target.Health > 0 then
				if NPC_RELATIONSHIPS[model.Name] then
					table.insert(priorityTargets, target)
				else
					table.insert(validNpcs, target)
				end
			end
		end
	end

	for i = #priorityTargets, 1, -1 do
		table.insert(validNpcs, 1, priorityTargets[i])
	end
	return validNpcs
end

local function attack(target)
	weaponCache = weaponCache and weaponCache.Parent and weaponCache or findMeleeWeapon()
	if not weaponCache or not target or not target.Parent or target.Health <= 0 then return end

	local verifyHit = weaponCache:FindFirstChild("VerifyHit")
	if verifyHit then
		verifyHit:FireServer(
			target,
			("x"):rep(8):gsub("x", function() return ("%x"):format(math.random(0, 0xf)) end)
		)
	end
end

RunService.Heartbeat:Connect(function()
	if not Aura.Enabled then return end

	local currentTime = tick()
	if (currentTime - lastCacheTime) > 0.5 then
		lastCacheTime = currentTime
		npcCache = findValidNPCs()
	end

	for _, target in ipairs(npcCache) do
		task.spawn(
			attack,
			target
		)
	end
end)

return Aura
