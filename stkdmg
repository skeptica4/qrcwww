-- Configuration 1.5
local multiplier = true      -- Toggle damage multiplier on/off

-- Set up global access
_G.multiplier = multiplier

-- Implementation
pcall(function()
	-- Get game metatable
	local mt = getrawmetatable(game)
	setreadonly(mt, false)
	
	-- Store original namecall method
	local originalNamecall = mt.__namecall
	
	-- Active target tracking
	local currentTarget = nil
	local targetLocked = false
	local burstActive = false
	
	-- Override namecall method
	mt.__namecall = newcclosure(function(self, ...)
		local method = getnamecallmethod()
		local args = {...}
		
		-- Check if this is a hit verification
		if _G.multiplier and 
		   method == "FireServer" and 
		   tostring(self) == "VerifyHit" then
			
			local localPlayer = game:GetService("Players").LocalPlayer
			local character = localPlayer.Character
			
			if character and self:IsDescendantOf(character) then
				-- Get target info
				local target = args[1]
				
				if target and target:IsA("Humanoid") then
					-- New target detected or target changed
					if not burstActive or currentTarget ~= target then
						currentTarget = target
						targetLocked = true
						burstActive = true
						
						local npcParent = target.Parent
						local npcName = npcParent.Name
						local startingHealth = target.Health
						
						print("Locking onto " .. npcName .. " (Health: " .. startingHealth .. ")")
						
						-- Spawn persistent burst loop
						task.spawn(function()
							local hitCount = 1
							local activeTarget = currentTarget
							local activeSelf = self
							local baseArgs = args
							
							while targetLocked and activeTarget == currentTarget do
								-- Check if target is still valid and alive
								local targetHealth = activeTarget.Health
								local targetParent = activeTarget.Parent
								
								if not targetParent or targetHealth <= 0 then
									print(npcName .. " eliminated after " .. hitCount .. " hits!")
									
									-- Release lock to allow new target
									if activeTarget == currentTarget then
										currentTarget = nil
										targetLocked = false
										burstActive = false
									end
									break
								end
								
								-- Continue burst on current target
								hitCount = hitCount + 1
								
								pcall(function()
									-- Create position variation
									local originalPos = baseArgs[3]
									
									if typeof(originalPos) == "Vector3" then
										-- Add tiny random offset
										local variance = 0.01
										local halfVar = variance / 2
										local randomX = math.random() * variance - halfVar
										local randomY = math.random() * variance - halfVar
										local randomZ = math.random() * variance - halfVar
										
										local newPos = Vector3.new(
											originalPos.X + randomX,
											originalPos.Y + randomY,
											originalPos.Z + randomZ
										)
										
										-- Build modified args
										local newArgs = {
											baseArgs[1],
											baseArgs[2],
											newPos
										}
										
										local argCount = #baseArgs
										for j = 4, argCount do
											newArgs[j] = baseArgs[j]
										end
										
										-- Fire server
										activeSelf.FireServer(activeSelf, unpack(newArgs))
									else
										-- Use original args
										activeSelf.FireServer(activeSelf, unpack(baseArgs))
									end
								end)
								
								-- Safety check
								if hitCount > 150 then
									print("Safety limit reached on " .. npcName)
									
									if activeTarget == currentTarget then
										currentTarget = nil
										targetLocked = false
										burstActive = false
									end
									break
								end
								
								-- Small delay to prevent server overload
								task.wait(0.01)
							end
						end)
					end
				end
			end
		end
		
		-- Call original method
		return originalNamecall(self, ...)
	end)
	
	-- Restore metatable protection
	setreadonly(mt, true)
	
	print("Persistent target burst system " .. (multiplier and "enabled" or "disabled"))
	print("Will lock onto targets and burst until dead, then auto-switch!")
end)
