-- VapeV4 Stack Damage & Gun Modifier Combined Script
-- Standalone Implementation

-- Load VapeV4 as Independent
shared.VapeIndependent = true
local vape = loadstring(
	game:HttpGet(
		'https://raw.githubusercontent.com/7GrandDadPGN/VapeV4ForRoblox/main/NewMainScript.lua', 
		true
	)
)()

-- Set config name
vape.Place = 'CombatEnhancer'

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- Gun Modifier Constants
local ALLOWED_GUNS = {
	"Akimbo", "Voltaic Impact", "Gunslingers", "Burst Rifle", "Stonewall",
	"Steelforge", "DMR", "Gift of Fire", "Armour Peeler", "Medical Bow",
	"Recurve", "Vitabow", "Rifle", "Bolter", "Harpoon Gun", "RPG",
	"Rocket Stormer", "Shockwave Device", "Shotgun", "Hallsweeper",
	"Sprinter's Streak", "SMG", "Loose Trigger", "Twinface",
	"Mastermind's Rifle", "Shovel", "Overcharger", "Rallying Cry",
	"Machete", "Handaxes", "Torqueblade"
}

-- Stack Damage Module Implementation
local StackDamage
StackDamage = vape.Categories.Combat:CreateModule({
	Name = 'Stack Damage',
	Function = function(callback)
		if callback then
			-- Module enabled
			print('Stack Damage enabled - Target locking system active')
			
			-- Store original state
			local originalNamecall
			local gameMetatable
			local targetLocked = false
			local burstActive = false
			local currentTarget = nil
			
			-- Implementation
			pcall(function()
				-- Get game metatable
				gameMetatable = getrawmetatable(game)
				setreadonly(gameMetatable, false)
				
				-- Store original namecall method
				originalNamecall = gameMetatable.__namecall
				
				-- Override namecall method
				gameMetatable.__namecall = newcclosure(function(self, ...)
					local method = getnamecallmethod()
					local args = {...}
					
					-- Check if this is a hit verification and module is enabled
					if StackDamage.Enabled and 
					   method == "FireServer" and 
					   tostring(self) == "VerifyHit" then
						
						local localPlayer = game:GetService("Players").LocalPlayer
						local character = localPlayer.Character
						
						if character and self:IsDescendantOf(character) then
							-- Get target info
							local target = args[1]
							
							if target and target:IsA("Humanoid") then
								-- New target detected or target changed
								if not burstActive or currentTarget ~= target then
									currentTarget = target
									targetLocked = true
									burstActive = true
									
									local npcParent = target.Parent
									local npcName = npcParent.Name
									local startingHealth = target.Health
									
									print(
										"Stack Damage: Locking onto " .. 
										npcName .. 
										" (Health: " .. 
										startingHealth .. 
										")"
									)
									
									-- Spawn persistent burst loop
									task.spawn(function()
										local hitCount = 1
										local activeTarget = currentTarget
										local activeSelf = self
										local baseArgs = args
										local safetyLimit = StackDamage.SafetyLimit or 150
										local burstDelay = StackDamage.BurstDelay or 0.01
										
										while targetLocked and 
											  activeTarget == currentTarget and 
											  StackDamage.Enabled do
											
											-- Check if target is still valid and alive
											local targetHealth = activeTarget.Health
											local targetParent = activeTarget.Parent
											
											if not targetParent or targetHealth <= 0 then
												print(
													"Stack Damage: " .. 
													npcName .. 
													" eliminated after " .. 
													hitCount .. 
													" hits!"
												)
												
												-- Release lock to allow new target
												if activeTarget == currentTarget then
													currentTarget = nil
													targetLocked = false
													burstActive = false
												end
												break
											end
											
											-- Continue burst on current target
											hitCount = hitCount + 1
											
											pcall(function()
												-- Create position variation
												local originalPos = baseArgs[3]
												
												if typeof(originalPos) == "Vector3" then
													-- Add tiny random offset
													local variance = 0.01
													local halfVar = variance / 2
													local randomX = math.random() * variance - halfVar
													local randomY = math.random() * variance - halfVar
													local randomZ = math.random() * variance - halfVar
													
													local newPos = Vector3.new(
														originalPos.X + randomX,
														originalPos.Y + randomY,
														originalPos.Z + randomZ
													)
													
													-- Build modified args
													local newArgs = {
														baseArgs[1],
														baseArgs[2],
														newPos
													}
													
													local argCount = #baseArgs
													for j = 4, argCount do
														newArgs[j] = baseArgs[j]
													end
													
													-- Fire server
													activeSelf.FireServer(activeSelf, unpack(newArgs))
												else
													-- Use original args
													activeSelf.FireServer(activeSelf, unpack(baseArgs))
												end
											end)
											
											-- Safety check
											if hitCount > safetyLimit then
												print(
													"Stack Damage: Safety limit reached on " .. 
													npcName
												)
												
												if activeTarget == currentTarget then
													currentTarget = nil
													targetLocked = false
													burstActive = false
												end
												break
											end
											
											-- Small delay to prevent server overload
											task.wait(burstDelay)
										end
									end)
								end
							end
						end
					end
					
					-- Call original method
					return originalNamecall(self, ...)
				end)
				
				-- Restore metatable protection
				setreadonly(gameMetatable, true)
			end)
			
			-- Clean up when module is disabled
			StackDamage:Clean(function()
				-- Reset target tracking
				currentTarget = nil
				targetLocked = false
				burstActive = false
				
				-- Restore original namecall if it exists
				if originalNamecall and gameMetatable then
					pcall(function()
						setreadonly(gameMetatable, false)
						gameMetatable.__namecall = originalNamecall
						setreadonly(gameMetatable, true)
					end)
				end
				
				print('Stack Damage disabled - Original hooks restored')
			end)
			
		else
			-- Module disabled (cleanup handled by Clean function above)
		end
	end,
	ExtraText = function()
		return 'Burst'
	end,
	Tooltip = 'Multiplies damage by locking onto targets and bursting until eliminated'
})

-- Stack Damage Configuration Components
local MultiplierEnabled
MultiplierEnabled = StackDamage:CreateToggle({
	Name = 'Damage Multiplier',
	Function = function(callback)
		_G.multiplier = callback
		if callback then
			print('Stack Damage: Multiplier enabled')
		else
			print('Stack Damage: Multiplier disabled')
		end
	end,
	Default = true,
	Tooltip = 'Toggle damage multiplication on/off'
})

local SafetyLimit
SafetyLimit = StackDamage:CreateSlider({
	Name = 'Safety Limit',
	Min = 50,
	Max = 300,
	Function = function(val)
		StackDamage.SafetyLimit = val
	end,
	Default = 150,
	Suffix = ' hits',
	Tooltip = 'Maximum hits per target before auto-release'
})

local BurstDelay
BurstDelay = StackDamage:CreateSlider({
	Name = 'Burst Delay',
	Min = 0.005,
	Max = 0.1,
	Function = function(val)
		StackDamage.BurstDelay = val
	end,
	Default = 0.01,
	Decimal = 1000,
	Suffix = 's',
	Tooltip = 'Delay between each burst hit'
})

-- Initialize Stack Damage default values
StackDamage.SafetyLimit = 150
StackDamage.BurstDelay = 0.01
_G.multiplier = true

-- Gun Modifier Module Implementation
local GunModifier
GunModifier = vape.Categories.Combat:CreateModule({
	Name = 'Gun Modifier',
	Function = function(callback)
		if callback then
			print('Gun Modifier enabled - Weapon enhancement active')
			
			-- Local variables for gun modification
			local lastWeapon = nil
			local reloadCooldown = 0
			local weaponConnection
			local reloadConnection
			
			-- Helper functions
			local getWpn = function()
				local character = LocalPlayer.Character
				if not character then
					return nil
				end
				
				local children = character:GetChildren()
				for _, item in ipairs(children) do
					if item:IsA("Tool") and table.find(ALLOWED_GUNS, item.Name) then
						return item.Name
					end
				end
				
				return nil
			end
			
			local getCurrentAmmo = function(tool)
				local descendants = {tool, unpack(tool:GetDescendants())}
				
				for _, obj in ipairs(descendants) do
					local attributes = obj:GetAttributes()
					for name, value in pairs(attributes) do
						if name:lower():find("ammo") and typeof(value) == "number" then
							return value, obj, name
						end
					end
				end
				
				return nil, nil, nil
			end
			
			local getMaxAmmo = function(obj, attrName)
				local attributes = obj:GetAttributes()
				local maxValue = attributes["Max" .. attrName]
				
				if not maxValue then
					maxValue = attributes[attrName .. "Max"]
				end
				
				if not maxValue then
					maxValue = attributes["MaxAmmo"]
				end
				
				return maxValue or 30
			end
			
			local modifyGun = function(tool)
				if not tool or not GunModifier.Enabled then
					return
				end
				
				local firerateValue = GunModifier.Firerate or 500
				local bulletSpeedValue = GunModifier.BulletSpeed or 9999
				local spreadValue = GunModifier.Spread or 0
				local reloadTimeValue = GunModifier.ReloadTime or 0.1
				local infiniteAmmoEnabled = GunModifier.InfiniteAmmo or true
				
				tool:SetAttribute("Firerate", firerateValue)
				tool:SetAttribute("BulletSpeed", bulletSpeedValue)
				tool:SetAttribute("Spread", spreadValue)
				tool:SetAttribute("ReloadTime", reloadTimeValue)
				
				if infiniteAmmoEnabled then
					local ammoConnection = tool:GetAttributeChangedSignal("Ammo"):Connect(function()
						if GunModifier.Enabled then
							tool:SetAttribute("Ammo", 999)
						end
					end)
					
					GunModifier:Clean(ammoConnection)
					tool:SetAttribute("Ammo", 999)
				end
			end
			
			local fastReload = function(tool)
				if not tool or not GunModifier.Enabled or tick() - reloadCooldown < 0.1 then
					return
				end
				
				reloadCooldown = tick()
				local descendants = {tool, unpack(tool:GetDescendants())}
				
				for _, obj in ipairs(descendants) do
					local attributes = obj:GetAttributes()
					for name, value in pairs(attributes) do
						if name:lower():find("ammo") and typeof(value) == "number" then
							local maxAmmo = getMaxAmmo(obj, name)
							obj:SetAttribute(name, maxAmmo)
						end
					end
				end
				
				local character = LocalPlayer.Character
				if character then
					local humanoid = character:FindFirstChildOfClass("Humanoid")
					if humanoid then
						local tracks = humanoid:GetPlayingAnimationTracks()
						for _, track in ipairs(tracks) do
							if track.Name:lower():find("reload") then
								track:Stop()
								track.TimePosition = track.Length
							end
						end
					end
				end
				
				print("Gun Modifier: Fast reload triggered")
			end
			
			-- Weapon detection loop
			weaponConnection = RunService.Heartbeat:Connect(function()
				if not GunModifier.Enabled then
					return
				end
				
				local newWeapon = getWpn()
				
				if newWeapon and newWeapon ~= lastWeapon then
					lastWeapon = newWeapon
					local character = LocalPlayer.Character
					if character then
						local tool = character:FindFirstChild(newWeapon)
						if tool then
							modifyGun(tool)
							print("Gun Modifier: Gun modified - " .. newWeapon)
						end
					end
				end
			end)
			
			-- Manual reload on R key
			reloadConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
				if gameProcessed or 
				   input.KeyCode ~= Enum.KeyCode.R or 
				   not GunModifier.Enabled then
					return
				end
				
				local character = LocalPlayer.Character
				if character then
					local tool = character:FindFirstChildOfClass("Tool")
					if tool and table.find(ALLOWED_GUNS, tool.Name) then
						fastReload(tool)
					end
				end
			end)
			
			-- Clean up connections when module is disabled
			GunModifier:Clean(weaponConnection)
			GunModifier:Clean(reloadConnection)
			
		else
			print('Gun Modifier disabled')
		end
	end,
	ExtraText = function()
		return 'Enhanced'
	end,
	Tooltip = 'Modifies weapon stats and enables fast reload'
})

-- Gun Modifier Configuration Components
local FirerateSlider
FirerateSlider = GunModifier:CreateSlider({
	Name = 'Fire Rate',
	Min = 100,
	Max = 1000,
	Function = function(val)
		GunModifier.Firerate = val
	end,
	Default = 500,
	Suffix = ' RPM',
	Tooltip = 'Weapon fire rate in rounds per minute'
})

local BulletSpeedSlider
BulletSpeedSlider = GunModifier:CreateSlider({
	Name = 'Bullet Speed',
	Min = 1000,
	Max = 15000,
	Function = function(val)
		GunModifier.BulletSpeed = val
	end,
	Default = 9999,
	Suffix = ' u/s',
	Tooltip = 'Bullet velocity in units per second'
})

local SpreadSlider
SpreadSlider = GunModifier:CreateSlider({
	Name = 'Spread',
	Min = 0,
	Max = 10,
	Function = function(val)
		GunModifier.Spread = val
	end,
	Default = 0,
	Decimal = 10,
	Suffix = 'Â°',
	Tooltip = 'Weapon spread in degrees'
})

local ReloadTimeSlider
ReloadTimeSlider = GunModifier:CreateSlider({
	Name = 'Reload Time',
	Min = 0.1,
	Max = 3.0,
	Function = function(val)
		GunModifier.ReloadTime = val
	end,
	Default = 0.1,
	Decimal = 10,
	Suffix = 's',
	Tooltip = 'Weapon reload time in seconds'
})

local InfiniteAmmoToggle
InfiniteAmmoToggle = GunModifier:CreateToggle({
	Name = 'Infinite Ammo',
	Function = function(callback)
		GunModifier.InfiniteAmmo = callback
		if callback then
			print('Gun Modifier: Infinite ammo enabled')
		else
			print('Gun Modifier: Infinite ammo disabled')
		end
	end,
	Default = true,
	Tooltip = 'Enable infinite ammunition'
})

-- Initialize Gun Modifier default values
GunModifier.Firerate = 500
GunModifier.BulletSpeed = 9999
GunModifier.Spread = 0
GunModifier.ReloadTime = 0.1
GunModifier.InfiniteAmmo = true

-- Initialize VapeV4
vape:Init()

print('VapeV4 Combat Enhancer loaded successfully!')
print('Features: Stack Damage + Gun Modifier')
print('Press the GUI toggle key to access the Combat category')
