-- VapeV4 Combat Enhancer - Compact Version
-- Stack Damage + Gun Modifier with Libraries Integration

shared.VapeIndependent = true
local vape = loadstring(
	game:HttpGet(
		'https://raw.githubusercontent.com/7GrandDadPGN/VapeV4ForRoblox/main/NewMainScript.lua', 
		true
	)
)()

vape.Place = 'CombatEnhancer'

-- Services & Libraries
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- VapeV4 Libraries
local entitylib = vape.Libraries.entitylib
local sessioninfo = vape.Libraries.SessionInfo
local targetinfo = vape.Libraries.TargetInfo

-- Gun Constants
local GUNS = {
	"Akimbo", "Voltaic Impact", "Gunslingers", "Burst Rifle", "Stonewall",
	"Steelforge", "DMR", "Gift of Fire", "Armour Peeler", "Medical Bow",
	"Recurve", "Vitabow", "Rifle", "Bolter", "Harpoon Gun", "RPG",
	"Rocket Stormer", "Shockwave Device", "Shotgun", "Hallsweeper",
	"Sprinter's Streak", "SMG", "Loose Trigger", "Twinface",
	"Mastermind's Rifle", "Shovel", "Overcharger", "Rallying Cry",
	"Machete", "Handaxes", "Torqueblade"
}

-- Session tracking
local killsTracker = sessioninfo:AddItem('Kills', 0, function(val) return val end, true)
local hitsTracker = sessioninfo:AddItem('Hits', 0, function(val) return val end, true)

-- Stack Damage Module
local StackDamage
StackDamage = vape.Categories.Combat:CreateModule({
	Name = 'Stack Damage',
	Function = function(callback)
		if callback then
			local originalNamecall, gameMetatable
			local currentTarget, targetLocked, burstActive = nil, false, false
			
			pcall(function()
				gameMetatable = getrawmetatable(game)
				setreadonly(gameMetatable, false)
				originalNamecall = gameMetatable.__namecall
				
				gameMetatable.__namecall = newcclosure(function(self, ...)
					local method = getnamecallmethod()
					local args = {...}
					
					if StackDamage.Enabled and 
					   method == "FireServer" and 
					   tostring(self) == "VerifyHit" then
						
						local character = LocalPlayer.Character
						if character and self:IsDescendantOf(character) then
							local target = args[1]
							
							if target and target:IsA("Humanoid") then
								-- Use entity library for better target management
								local entity = entitylib.getEntity(target.Parent)
								if entity and entitylib.isVulnerable(entity) then
									
									if not burstActive or currentTarget ~= target then
										currentTarget = target
										targetLocked = true
										burstActive = true
										
										-- Add to target info display
										targetinfo.Targets[entity] = tick() + 2
										
										task.spawn(function()
											local hitCount = 1
											local npcName = target.Parent.Name
											local safetyLimit = StackDamage.SafetyLimit or 150
											local burstDelay = StackDamage.BurstDelay or 0.01
											
											while targetLocked and 
												  currentTarget == target and 
												  StackDamage.Enabled do
												
												if target.Health <= 0 or not target.Parent then
													killsTracker:Increment()
													print("Eliminated: " .. npcName .. " (" .. hitCount .. " hits)")
													currentTarget = nil
													targetLocked = false
													burstActive = false
													break
												end
												
												hitCount = hitCount + 1
												hitsTracker:Increment()
												
												pcall(function()
													local originalPos = args[3]
													if typeof(originalPos) == "Vector3" then
														local variance = 0.01
														local newPos = Vector3.new(
															originalPos.X + (math.random() - 0.5) * variance,
															originalPos.Y + (math.random() - 0.5) * variance,
															originalPos.Z + (math.random() - 0.5) * variance
														)
														
														local newArgs = {args[1], args[2], newPos}
														for j = 4, #args do
															newArgs[j] = args[j]
														end
														
														self.FireServer(self, unpack(newArgs))
													else
														self.FireServer(self, unpack(args))
													end
												end)
												
												if hitCount > safetyLimit then
													print("Safety limit reached: " .. npcName)
													currentTarget = nil
													targetLocked = false
													burstActive = false
													break
												end
												
												task.wait(burstDelay)
											end
										end)
									end
								end
							end
						end
					end
					
					return originalNamecall(self, ...)
				end)
				
				setreadonly(gameMetatable, true)
			end)
			
			StackDamage:Clean(function()
				currentTarget = nil
				targetLocked = false
				burstActive = false
				
				if originalNamecall and gameMetatable then
					pcall(function()
						setreadonly(gameMetatable, false)
						gameMetatable.__namecall = originalNamecall
						setreadonly(gameMetatable, true)
					end)
				end
				
				print('Stack Damage disabled')
			end)
		end
	end,
	ExtraText = function()
		return 'Burst'
	end,
	Tooltip = 'Multiplies damage by locking onto targets until eliminated'
})

-- Gun Modifier Module
local GunModifier
GunModifier = vape.Categories.Combat:CreateModule({
	Name = 'Gun Modifier',
	Function = function(callback)
		if callback then
			local lastWeapon, reloadCooldown = nil, 0
			
			local getWpn = function()
				local character = LocalPlayer.Character
				if not character then return nil end
				
				for _, item in pairs(character:GetChildren()) do
					if item:IsA("Tool") and table.find(GUNS, item.Name) then
						return item.Name
					end
				end
			end
			
			local modifyGun = function(tool)
				if not tool or not GunModifier.Enabled then return end
				
				tool:SetAttribute("Firerate", GunModifier.Firerate or 500)
				tool:SetAttribute("BulletSpeed", GunModifier.BulletSpeed or 9999)
				tool:SetAttribute("Spread", GunModifier.Spread or 0)
				tool:SetAttribute("ReloadTime", GunModifier.ReloadTime or 0.1)
				
				if GunModifier.InfiniteAmmo then
					local ammoConnection = tool:GetAttributeChangedSignal("Ammo"):Connect(function()
						if GunModifier.Enabled then
							tool:SetAttribute("Ammo", 999)
						end
					end)
					
					GunModifier:Clean(ammoConnection)
					tool:SetAttribute("Ammo", 999)
				end
			end
			
			local fastReload = function(tool)
				if not tool or not GunModifier.Enabled or tick() - reloadCooldown < 0.1 then
					return
				end
				
				reloadCooldown = tick()
				local descendants = {tool, unpack(tool:GetDescendants())}
				
				for _, obj in pairs(descendants) do
					local attributes = obj:GetAttributes()
					for name, value in pairs(attributes) do
						if name:lower():find("ammo") and typeof(value) == "number" then
							local maxAmmo = attributes["Max" .. name] or 
											attributes[name .. "Max"] or 
											attributes["MaxAmmo"] or 30
							obj:SetAttribute(name, maxAmmo)
						end
					end
				end
				
				local character = LocalPlayer.Character
				if character then
					local humanoid = character:FindFirstChildOfClass("Humanoid")
					if humanoid then
						for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
							if track.Name:lower():find("reload") then
								track:Stop()
								track.TimePosition = track.Length
							end
						end
					end
				end
			end
			
			-- Weapon detection
			local weaponConnection = RunService.Heartbeat:Connect(function()
				if not GunModifier.Enabled then return end
				
				local newWeapon = getWpn()
				if newWeapon and newWeapon ~= lastWeapon then
					lastWeapon = newWeapon
					local character = LocalPlayer.Character
					if character then
						local tool = character:FindFirstChild(newWeapon)
						if tool then
							modifyGun(tool)
							print("Gun modified: " .. newWeapon)
						end
					end
				end
			end)
			
			-- Fast reload input
			local reloadConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
				if gameProcessed or input.KeyCode ~= Enum.KeyCode.R or not GunModifier.Enabled then
					return
				end
				
				local character = LocalPlayer.Character
				if character then
					local tool = character:FindFirstChildOfClass("Tool")
					if tool and table.find(GUNS, tool.Name) then
						fastReload(tool)
					end
				end
			end)
			
			GunModifier:Clean(weaponConnection)
			GunModifier:Clean(reloadConnection)
		end
	end,
	ExtraText = function()
		return 'Enhanced'
	end,
	Tooltip = 'Modifies weapon stats and enables fast reload'
})

-- Stack Damage Configuration
StackDamage:CreateToggle({
	Name = 'Damage Multiplier',
	Function = function(callback)
		_G.multiplier = callback
	end,
	Default = true,
	Tooltip = 'Toggle damage multiplication'
})

StackDamage:CreateSlider({
	Name = 'Safety Limit',
	Min = 50,
	Max = 300,
	Function = function(val)
		StackDamage.SafetyLimit = val
	end,
	Default = 150,
	Suffix = ' hits',
	Tooltip = 'Maximum hits per target'
})

StackDamage:CreateSlider({
	Name = 'Burst Delay',
	Min = 0.005,
	Max = 0.1,
	Function = function(val)
		StackDamage.BurstDelay = val
	end,
	Default = 0.01,
	Decimal = 1000,
	Suffix = 's',
	Tooltip = 'Delay between burst hits'
})

-- Gun Modifier Configuration
GunModifier:CreateSlider({
	Name = 'Fire Rate',
	Min = 100,
	Max = 1000,
	Function = function(val)
		GunModifier.Firerate = val
	end,
	Default = 500,
	Suffix = ' RPM',
	Tooltip = 'Weapon fire rate'
})

GunModifier:CreateSlider({
	Name = 'Bullet Speed',
	Min = 1000,
	Max = 15000,
	Function = function(val)
		GunModifier.BulletSpeed = val
	end,
	Default = 9999,
	Suffix = ' u/s',
	Tooltip = 'Bullet velocity'
})

GunModifier:CreateSlider({
	Name = 'Spread',
	Min = 0,
	Max = 10,
	Function = function(val)
		GunModifier.Spread = val
	end,
	Default = 0,
	Decimal = 10,
	Suffix = 'Â°',
	Tooltip = 'Weapon spread'
})

GunModifier:CreateSlider({
	Name = 'Reload Time',
	Min = 0.1,
	Max = 3.0,
	Function = function(val)
		GunModifier.ReloadTime = val
	end,
	Default = 0.1,
	Decimal = 10,
	Suffix = 's',
	Tooltip = 'Reload duration'
})

GunModifier:CreateToggle({
	Name = 'Infinite Ammo',
	Function = function(callback)
		GunModifier.InfiniteAmmo = callback
	end,
	Default = true,
	Tooltip = 'Enable infinite ammunition'
})

-- Initialize default values
StackDamage.SafetyLimit = 150
StackDamage.BurstDelay = 0.01
GunModifier.Firerate = 500
GunModifier.BulletSpeed = 9999
GunModifier.Spread = 0
GunModifier.ReloadTime = 0.1
GunModifier.InfiniteAmmo = true
_G.multiplier = true

-- Initialize VapeV4
vape:Init()

print('VapeV4 Combat Enhancer loaded - ' .. vape.Version)
