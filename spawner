--[[
    Standalone Spawner (Local Commands)
    This script provides in-game tool spawning functionality using local-only "/e" commands.
    It now searches for tools in both ReplicatedStorage.Tools and ReplicatedStorage.Upgrades.
]]

--================================================================
-- Services
--================================================================
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")

--================================================================
-- Local Player
--================================================================
local LocalPlayer = Players.LocalPlayer

--================================================================
-- Helper Functions
--================================================================

--- Sends a notification to the local player's screen.
-- @param title The title of the notification.
-- @param text The body text of the notification.
-- @param duration The duration in seconds for the notification to be visible.
local function sendNotification(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Icon = "rbxassetid://13158724154", -- Notification icon
        Duration = duration,
    })
end

--- Spawns a tool by cloning it from ReplicatedStorage and replacing the contents of a tool in the player's backpack.
-- @param toolNameToSpawn The name of the tool to clone from ReplicatedStorage.
-- @param targetBackpackToolName The name of the tool in the player's backpack to be modified.
local function spawnTool(toolNameToSpawn, targetBackpackToolName)
    print("Spawning tool: " .. tostring(toolNameToSpawn) .. " into " .. tostring(targetBackpackToolName))

    -- Validate input by trimming whitespace and checking for nil/empty strings.
    if not toolNameToSpawn or toolNameToSpawn == "" then
        warn("Invalid tool name provided.")
        sendNotification("Spawn Error", "You must provide a tool name.", 5)
        return
    end
    if not targetBackpackToolName or targetBackpackToolName == "" then
        warn("Invalid backpack item name provided.")
        sendNotification("Spawn Error", "You must provide a target backpack item.", 5)
        return
    end

    -- Search for the source tool first in ReplicatedStorage.Tools, then in ReplicatedStorage.Upgrades
    local sourceTool = ReplicatedStorage.Tools:FindFirstChild(toolNameToSpawn)
    if not sourceTool then
        sourceTool = ReplicatedStorage.Upgrades:FindFirstChild(toolNameToSpawn)
    end
    
    if not sourceTool then
        warn("Source tool not found in ReplicatedStorage (checked Tools and Upgrades): " .. toolNameToSpawn)
        sendNotification("Spawn Error", "Tool '" .. toolNameToSpawn .. "' not found.", 5)
        return
    end

    local targetTool = LocalPlayer.Backpack:FindFirstChild(targetBackpackToolName)
    if not targetTool then
        warn("Target tool not found in backpack: " .. targetBackpackToolName)
        sendNotification("Spawn Error", "Backpack item '" .. targetBackpackToolName .. "' not found.", 5)
        return
    end

    -- Clear the existing contents of the target tool, but keep the "Id" object if it exists.
    for _, child in ipairs(targetTool:GetChildren()) do
        if child.Name ~= "Id" then
            child:Destroy()
        end
    end

    -- Clone the children of the source tool into the target tool.
    for _, child in ipairs(sourceTool:GetChildren()) do
        child:Clone().Parent = targetTool
    end
    
    sendNotification("Success", "'" .. toolNameToSpawn .. "' has been spawned into '" .. targetBackpackToolName .. "'.", 5)
end

--================================================================
-- Main Logic
--================================================================

sendNotification("Standalone Spawner", "Script loaded. Use /e spawn,tool,target", 7)

-- Listen for chat commands from the local player.
LocalPlayer.Chatted:Connect(function(message)
    -- Only process commands that start with "/e "
    if string.sub(message, 1, 3) ~= "/e " then
        return
    end

    -- Extract the command and its arguments
    local commandString = string.sub(message, 4)
    local commandArgs = string.split(commandString, ",")
    
    -- The first part is the command name, clean it up.
    local commandName = string.lower(string.gsub(commandArgs[1], "^%s*(.-)%s*$", "%1"))

    -- --- Command: reset ---
    if commandName == "reset" then
        local remotes = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("To_Server")
        remotes:WaitForChild("Handle_Initiate_S"):FireServer("Add_Knockedout")
        remotes:WaitForChild("Sun_Damage"):FireServer()
        wait()
        remotes:WaitForChild("Sun_Damage"):FireServer()
        wait()
        remotes:WaitForChild("Sun_Damage"):FireServer()
        sendNotification("Reset", "Character has been reset.", 3)
        
    -- --- Command: spawn ---
    elseif commandName == "spawn" then
        -- Arguments are the 2nd and 3rd parts, trim any extra spaces.
        local toolName = commandArgs[2]
        local backpackItem = commandArgs[3]

        if toolName then toolName = string.gsub(toolName, "^%s*(.-)%s*$", "%1") end
        if backpackItem then backpackItem = string.gsub(backpackItem, "^%s*(.-)%s*$", "%1") end
        
        spawnTool(toolName, backpackItem)
    end
end)
