-- Fluent Library Base Template
-- Ready for script integration based on your instructions

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Script Hub " .. Fluent.Version,
    SubTitle = "Custom Integration",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- Create Tabs
local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Player = Window:AddTab({ Title = "Player", Icon = "user" }),
    Combat = Window:AddTab({ Title = "Combat", Icon = "sword" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "package" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- ============================================
-- MAIN TAB
-- ============================================
do
    Tabs.Main:AddParagraph({
        Title = "Welcome",
        Content = "Features will be added here based on your script snippets."
    })

    -- NPC Teleportation
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local LocalPlayer = Players.LocalPlayer
    
    local EXCLUDED_NPCS = {
        Landmine = true,
        Man = true,
        Turret = true,
        Stonehedge = true,
        Sprayer = true,
        Sentinel = true,
        Refugee = true,
        PDC = true,
        MADS = true,
        Lifeline = true,
        Hallucinator = true,
        Governor = true,
        FAST_point = true,
        Barrier = true,
        Platform = true,
        Administrator = true
    }
    
    for i = 1, 11 do
        if i ~= 8 then
            EXCLUDED_NPCS["dead guy " .. i] = true
        end
    end
    
    local getHRP = function()
        local character = LocalPlayer.Character
        return character and character:FindFirstChild("HumanoidRootPart")
    end
    
    local teleportNPCs = function()
        local hrp = getHRP()
        if not hrp then
            return
        end
        
        local playerPos = hrp.Position
        local playerForward = hrp.CFrame.LookVector
        local playerY = hrp.Orientation.Y
        local children = workspace:GetChildren()
        
        for _, npc in ipairs(children) do
            if not npc:IsA("Model") then
                continue
            end
            
            local npcName = npc.Name
            if EXCLUDED_NPCS[npcName] then
                continue
            end
            
            if Players:GetPlayerFromCharacter(npc) then
                continue
            end
            
            local humanoid = npc:FindFirstChildOfClass("Humanoid")
            local primaryPart = npc.PrimaryPart or npc:FindFirstChild("HumanoidRootPart")
            
            if not humanoid or not primaryPart or humanoid.Health <= 0 then
                continue
            end
            
            local distance = (npcName == "Tank") and 13 or 5.7
            local newCFrame = CFrame.new(playerPos + playerForward * distance)
            local rotatedCFrame = newCFrame * CFrame.Angles(0, playerY, 0)
            
            npc:SetPrimaryPartCFrame(rotatedCFrame)
        end
    end
    
    local npcTeleportConnection
    local throttle = 0
    
    local NPCTeleportToggle = Tabs.Main:AddToggle(
        "NPCTeleport",
        {
            Title = "NPC Teleport",
            Default = false
        }
    )
    
    NPCTeleportToggle:OnChanged(function()
        local enabled = Options.NPCTeleport.Value
        
        if enabled then
            throttle = 0
            npcTeleportConnection = RunService.Heartbeat:Connect(function(deltaTime)
                throttle = throttle + deltaTime
                
                if throttle >= 0.1 then
                    throttle = 0
                    teleportNPCs()
                end
            end)
        else
            if npcTeleportConnection then
                npcTeleportConnection:Disconnect()
                npcTeleportConnection = nil
            end
            throttle = 0
        end
    end)

    -- Killaura
    local KILLAURA_EXCLUDED_NPCS = {
        Landmine = true,
        Man = true,
        Turret = true,
        Stonehedge = true,
        Sprayer = true,
        Sentinel = true,
        Refugee = true,
        PDC = true,
        MADS = true,
        Lifeline = true,
        Hallucinator = true,
        Governor = true,
        FAST_point = true,
        Barrier = true,
        Administrator = true
    }
    
    for i = 1, 11 do
        KILLAURA_EXCLUDED_NPCS["dead guy " .. i] = true
    end
    
    local SPECIAL_NPC_PATHS = {
        APU = {childName = "Pilot", targetClass = "Humanoid"},
        Tank = {childName = "PropaneTank", targetClass = "Humanoid", findAll = true},
        Platform = {pattern = "Emplacement%d", targetClass = "Humanoid", findAll = true}
    }
    
    local NPC_RELATIONSHIPS = {
        Drone = {protects = "Achilles"}
    }
    
    local cachedMeleeWeapon = nil
    local validNPCsCache = {}
    local lastNPCFindTime = 0
    local killauraEnabled = false
    local attackLoopWaitTime = 0.05
    local npcCacheRefreshRate = 0.5
    
    local generateUUID = function()
        local template = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
        return string.gsub(
            template,
            "[xy]",
            function(c)
                local v = (c == "x") and math.random(0, 0xf) or math.random(8, 0xb)
                return string.format("%x", v)
            end
        )
    end
    
    local getCharacter = function()
        return LocalPlayer.Character
    end
    
    local findMeleeWeapon = function()
        local character = getCharacter()
        if not character then
            return nil
        end
        
        local backpack = LocalPlayer:FindFirstChild("Backpack")
        local locations = {character, backpack}
        
        for _, location in ipairs(locations) do
            if not location then
                continue
            end
            
            local children = location:GetChildren()
            for _, item in ipairs(children) do
                if not item:IsA("Tool") then
                    continue
                end
                
                local isMeleeClass = item:GetAttribute("Class") == "Melee"
                local isShovel = item.Name == "Shovel"
                
                if isMeleeClass or isShovel then
                    local verifyHit = item:FindFirstChild("VerifyHit")
                    if verifyHit and verifyHit:IsA("RemoteEvent") then
                        return item
                    end
                end
            end
        end
        
        return nil
    end
    
    local findTargetInstance = function(model)
        local specialCase = SPECIAL_NPC_PATHS[model.Name]
        
        if specialCase then
            if specialCase.findAll then
                local children = model:GetChildren()
                for _, child in ipairs(children) do
                    local isMatch = specialCase.pattern and string.match(child.Name, specialCase.pattern)
                    if not isMatch then
                        continue
                    end
                    
                    local target = child:FindFirstChildOfClass(specialCase.targetClass)
                    if target and target:IsA("Humanoid") and target.Health > 0 then
                        return target
                    end
                end
            else
                local child = model:FindFirstChild(specialCase.childName)
                if child then
                    local target = child:FindFirstChildOfClass(specialCase.targetClass)
                    if target and target:IsA("Humanoid") and target.Health > 0 then
                        return target
                    end
                end
            end
        else
            local humanoid = model:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then
                return humanoid
            end
        end
        
        return nil
    end
    
    local areAllEmplacementsDestroyed = function(platform)
        local children = platform:GetChildren()
        for _, child in ipairs(children) do
            if string.match(child.Name, "Emplacement%d") then
                local humanoid = child:FindFirstChildOfClass("Humanoid")
                if humanoid and humanoid.Health > 0 then
                    return false
                end
            end
        end
        return true
    end
    
    local findValidNPCs = function()
        local character = getCharacter()
        if not character then
            return {}
        end
        
        local validNPCs = {}
        local protectorStates = {}
        local priorityTargets = {}
        local workspaceChildren = workspace:GetChildren()
        
        for _, npcModel in ipairs(workspaceChildren) do
            if not npcModel:IsA("Model") then
                continue
            end
            
            local relationship = NPC_RELATIONSHIPS[npcModel.Name]
            if not relationship or not relationship.protects then
                continue
            end
            
            local protectorHumanoid = npcModel:FindFirstChildOfClass("Humanoid")
            local isDead = (not protectorHumanoid or protectorHumanoid.Health <= 0)
            
            if type(relationship.protects) == "string" then
                protectorStates[relationship.protects] = {isProtectorDead = isDead}
            end
            
            if not isDead then
                table.insert(
                    priorityTargets,
                    {
                        model = npcModel,
                        targetInstance = protectorHumanoid,
                        priority = true
                    }
                )
            end
        end
        
        for _, npcModel in ipairs(workspaceChildren) do
            if not npcModel:IsA("Model") then
                continue
            end
            
            if KILLAURA_EXCLUDED_NPCS[npcModel.Name] then
                continue
            end
            
            if Players:GetPlayerFromCharacter(npcModel) then
                continue
            end
            
            if npcModel.Name == "Platform" then
                if areAllEmplacementsDestroyed(npcModel) then
                    local mainHumanoid = npcModel:FindFirstChildOfClass("Humanoid")
                    if mainHumanoid and mainHumanoid.Health > 0 then
                        table.insert(
                            validNPCs,
                            {model = npcModel, targetInstance = mainHumanoid}
                        )
                    end
                else
                    local children = npcModel:GetChildren()
                    for _, child in ipairs(children) do
                        if string.match(child.Name, "Emplacement%d") then
                            local target = child:FindFirstChildOfClass("Humanoid")
                            if target and target.Health > 0 then
                                table.insert(
                                    validNPCs,
                                    {model = npcModel, targetInstance = target}
                                )
                            end
                        end
                    end
                end
                continue
            end
            
            local targetInstance = findTargetInstance(npcModel)
            if targetInstance then
                table.insert(
                    validNPCs,
                    {model = npcModel, targetInstance = targetInstance}
                )
            end
        end
        
        for i = #priorityTargets, 1, -1 do
            table.insert(validNPCs, 1, priorityTargets[i])
        end
        
        return validNPCs
    end
    
    local attackNPC = function(npcData)
        if not cachedMeleeWeapon or not cachedMeleeWeapon.Parent then
            cachedMeleeWeapon = findMeleeWeapon()
            if not cachedMeleeWeapon then
                return false
            end
        end
        
        if not npcData.targetInstance or not npcData.targetInstance.Parent then
            return false
        end
        
        local verifyHit = cachedMeleeWeapon:FindFirstChild("VerifyHit")
        if not verifyHit or not verifyHit:IsA("RemoteEvent") then
            cachedMeleeWeapon = nil
            return false
        end
        
        local uniqueID = generateUUID()
        verifyHit:FireServer(npcData.targetInstance, uniqueID)
        return true
    end
    
    local killauraConnection
    
    local KillauraToggle = Tabs.Main:AddToggle(
        "Killaura",
        {
            Title = "Killaura",
            Default = false
        }
    )
    
    KillauraToggle:OnChanged(function()
        killauraEnabled = Options.Killaura.Value
        
        if killauraEnabled then
            killauraConnection = coroutine.wrap(function()
                while killauraEnabled do
                    local currentTime = tick()
                    
                    if currentTime - lastNPCFindTime > npcCacheRefreshRate then
                        validNPCsCache = findValidNPCs()
                        lastNPCFindTime = currentTime
                    end
                    
                    local cacheLength = #validNPCsCache
                    if cacheLength > 0 then
                        for _, npcData in ipairs(validNPCsCache) do
                            task.spawn(function()
                                attackNPC(npcData)
                            end)
                        end
                    end
                    
                    wait(attackLoopWaitTime)
                end
            end)()
        else
            validNPCsCache = {}
            lastNPCFindTime = 0
            cachedMeleeWeapon = nil
        end
    end)
end

-- ============================================
-- PLAYER TAB
-- ============================================
do
    Tabs.Player:AddParagraph({
        Title = "Player Features",
        Content = "Player-related features will be added here."
    })

    -- Player features will go here
end

-- ============================================
-- COMBAT TAB
-- ============================================
do
    Tabs.Combat:AddParagraph({
        Title = "Combat Features",
        Content = "Combat-related features will be added here."
    })

    -- Damage Multiplier
    local mt
    local originalNamecall
    local metatableModified = false
    
    local currentTarget = nil
    local targetLocked = false
    local burstActive = false
    
    local setupMultiplier = function()
        if metatableModified then
            return
        end
        
        pcall(function()
            mt = getrawmetatable(game)
            setreadonly(mt, false)
            
            originalNamecall = mt.__namecall
            
            mt.__namecall = newcclosure(function(self, ...)
                local method = getnamecallmethod()
                local args = {...}
                
                if _G.multiplier and 
                   method == "FireServer" and 
                   tostring(self) == "VerifyHit" then
                    
                    local localPlayer = game:GetService("Players").LocalPlayer
                    local character = localPlayer.Character
                    
                    if character and self:IsDescendantOf(character) then
                        local target = args[1]
                        
                        if target and target:IsA("Humanoid") then
                            if not burstActive or currentTarget ~= target then
                                currentTarget = target
                                targetLocked = true
                                burstActive = true
                                
                                local npcParent = target.Parent
                                local npcName = npcParent.Name
                                local startingHealth = target.Health
                                
                                print("Locking onto " .. npcName .. " (Health: " .. startingHealth .. ")")
                                
                                task.spawn(function()
                                    local hitCount = 1
                                    local activeTarget = currentTarget
                                    local activeSelf = self
                                    local baseArgs = args
                                    
                                    while targetLocked and activeTarget == currentTarget do
                                        local targetHealth = activeTarget.Health
                                        local targetParent = activeTarget.Parent
                                        
                                        if not targetParent or targetHealth <= 0 then
                                            print(npcName .. " eliminated after " .. hitCount .. " hits!")
                                            
                                            if activeTarget == currentTarget then
                                                currentTarget = nil
                                                targetLocked = false
                                                burstActive = false
                                            end
                                            break
                                        end
                                        
                                        hitCount = hitCount + 1
                                        
                                        pcall(function()
                                            local originalPos = baseArgs[3]
                                            
                                            if typeof(originalPos) == "Vector3" then
                                                local variance = 0.01
                                                local halfVar = variance / 2
                                                local randomX = math.random() * variance - halfVar
                                                local randomY = math.random() * variance - halfVar
                                                local randomZ = math.random() * variance - halfVar
                                                
                                                local newPos = Vector3.new(
                                                    originalPos.X + randomX,
                                                    originalPos.Y + randomY,
                                                    originalPos.Z + randomZ
                                                )
                                                
                                                local newArgs = {
                                                    baseArgs[1],
                                                    baseArgs[2],
                                                    newPos
                                                }
                                                
                                                local argCount = #baseArgs
                                                for j = 4, argCount do
                                                    newArgs[j] = baseArgs[j]
                                                end
                                                
                                                activeSelf.FireServer(activeSelf, unpack(newArgs))
                                            else
                                                activeSelf.FireServer(activeSelf, unpack(baseArgs))
                                            end
                                        end)
                                        
                                        if hitCount > 150 then
                                            print("Safety limit reached on " .. npcName)
                                            
                                            if activeTarget == currentTarget then
                                                currentTarget = nil
                                                targetLocked = false
                                                burstActive = false
                                            end
                                            break
                                        end
                                        
                                        task.wait(0.01)
                                    end
                                end)
                            end
                        end
                    end
                end
                
                return originalNamecall(self, ...)
            end)
            
            setreadonly(mt, true)
            metatableModified = true
            
            print("Damage multiplier metatable hook installed")
        end)
    end
    
    local cleanupMultiplier = function()
        if not metatableModified then
            return
        end
        
        pcall(function()
            setreadonly(mt, false)
            mt.__namecall = originalNamecall
            setreadonly(mt, true)
            
            currentTarget = nil
            targetLocked = false
            burstActive = false
            metatableModified = false
            
            print("Damage multiplier metatable hook removed")
        end)
    end
    
    local DamageMultiplierToggle = Tabs.Combat:AddToggle(
        "DamageMultiplier",
        {
            Title = "Damage Multiplier",
            Default = false
        }
    )
    
    DamageMultiplierToggle:OnChanged(function()
        local enabled = Options.DamageMultiplier.Value
        _G.multiplier = enabled
        
        if enabled then
            setupMultiplier()
        else
            cleanupMultiplier()
        end
    end)
end

-- ============================================
-- MISC TAB
-- ============================================
do
    Tabs.Misc:AddParagraph({
        Title = "Miscellaneous",
        Content = "Miscellaneous features will be added here."
    })

    -- Misc features will go here
end

-- ============================================
-- SETTINGS & CONFIGURATION
-- ============================================
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})

InterfaceManager:SetFolder("FluentScriptHub")
SaveManager:SetFolder("FluentScriptHub/GameConfigs")

InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

Window:SelectTab(1)

Fluent:Notify({
    Title = "Script Loaded",
    Content = "Ready for feature integration!",
    Duration = 5
})

SaveManager:LoadAutoloadConfig()
