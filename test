local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Weapon list
local VALID_WEAPONS = {
    "Akimbo", "Voltaic Impact", "Gunslingers", "Burst Rifle", "Stonewall",
    "Steelforge", "DMR", "Gift of Fire", "Armour Peeler", "Medical Bow",
    "Recurve", "Vitabow", "Rifle", "Bolter", "Harpoon Gun", "RPG",
    "Rocket Stormer", "Shockwave Device", "Shotgun", "Hallsweeper",
    "Sprinter's Streak", "SMG", "Loose Trigger", "Twinface",
    "Mastermind's Rifle", "Shovel", "Overcharger", "Rallying Cry",
    "Machete", "Handaxes", "Torqueblade"
}

-- NPCs to ignore
local EXCLUDED = {
    Landmine=1, Man=1, Turret=1, Stonehedge=1, Sprayer=1, 
    Sentinel=1, Refugee=1, PDC=1, MADS=1, Lifeline=1, 
    Hallucinator=1, Governor=1, FAST_point=1, Barrier=1, 
    Administrator=1
}
for i = 1, 11 do EXCLUDED["dead guy " .. i] = 1 end

-- Convert weapon list to lookup table for faster checking
local weaponLookup = {}
for _, name in ipairs(VALID_WEAPONS) do
    weaponLookup[name] = true
end

-- Active shooting tracking
local shooting = {}

-- Get current held weapon
local function getCurrentWeapon()
    local char = LocalPlayer.Character
    if not char then return nil end
    
    -- Check what's currently equipped
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and weaponLookup[tool.Name] then
            local verifyHit = tool:FindFirstChild("VerifyHit")
            if verifyHit and verifyHit:IsA("RemoteEvent") then
                return tool, verifyHit
            end
        end
    end
    
    return nil, nil
end

-- Find all valid targets in workspace
local function findTargets()
    local targets = {}
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return targets 
    end
    
    local myPos = char.HumanoidRootPart.Position
    
    for _, obj in ipairs(workspace:GetChildren()) do
        -- Skip excluded and player characters
        if obj:IsA("Model") and not EXCLUDED[obj.Name] and not Players:GetPlayerFromCharacter(obj) then
            local humanoid = obj:FindFirstChildOfClass("Humanoid")
            
            -- Special case handling
            if obj.Name == "APU" then
                local pilot = obj:FindFirstChild("Pilot")
                humanoid = pilot and pilot:FindFirstChildOfClass("Humanoid")
            elseif obj.Name == "Platform" then
                -- Check emplacements
                for _, child in ipairs(obj:GetChildren()) do
                    if child.Name:match("Emplacement%d") then
                        local h = child:FindFirstChildOfClass("Humanoid")
                        if h and h.Health > 0 then
                            table.insert(targets, {humanoid = h, model = child})
                        end
                    end
                end
            end
            
            -- Add regular humanoid targets
            if humanoid and humanoid.Health > 0 then
                table.insert(targets, {humanoid = humanoid, model = obj})
            end
        end
    end
    
    return targets
end

-- Kill a target
local function killTarget(target, weapon, remote)
    -- Avoid duplicate shooting
    if shooting[target.humanoid] then return end
    shooting[target.humanoid] = true
    
    task.spawn(function()
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild("HumanoidRootPart") then
            shooting[target.humanoid] = nil
            return
        end
        
        -- Get body parts to shoot at
        local parts = {}
        for _, part in ipairs(target.model:GetDescendants()) do
            if part:IsA("BasePart") and #parts < 5 then
                table.insert(parts, part)
            end
        end
        
        -- Default to model position if no parts found
        if #parts == 0 then
            parts = {{Position = target.model:GetPivot().Position}}
        end
        
        -- Shoot until dead
        local shots = 0
        while target.humanoid.Parent and target.humanoid.Health > 0 and shots < 150 do
            shots = shots + 1
            
            -- Pick random body part
            local part = parts[math.random(1, #parts)]
            
            -- Calculate positions
            local hitPos = part.Position + Vector3.new(
                math.random() * 0.5 - 0.25,
                math.random() * 0.5 - 0.25,
                math.random() * 0.5 - 0.25
            )
            
            local shooterPos = char.HumanoidRootPart.Position
            
            -- Send the remote
            pcall(function()
                remote:FireServer(target.humanoid, hitPos, shooterPos)
            end)
            
            task.wait(0.005)  -- Fast firing
        end
        
        shooting[target.humanoid] = nil
    end)
end

-- Main loop - runs forever
while true do
    local weapon, remote = getCurrentWeapon()
    
    if weapon and remote then
        -- We have a weapon equipped, find and kill targets
        local targets = findTargets()
        
        for _, target in ipairs(targets) do
            killTarget(target, weapon, remote)
            task.wait(0.01)  -- Small delay between starting new targets
        end
    end
    
    -- Cleanup dead references
    for humanoid, _ in pairs(shooting) do
        if not humanoid.Parent or humanoid.Health <= 0 then
            shooting[humanoid] = nil
        end
    end
    
    task.wait(0.1)  -- Main loop speed
end
