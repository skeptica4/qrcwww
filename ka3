local Players, UserInputService = game:GetService("Players"), game:GetService("UserInputService")
local LocalPlayer, workspace = Players.LocalPlayer, workspace

local isMobile = not UserInputService.KeyboardEnabled

local CONFIG = {enabled = false, attackLoopWaitTime = 0.05, npcCacheRefreshRate = 0.5}
local EXCLUDED_NPCS = {Landmine=1, Man=1, Turret=1, Stonehedge=1, Sprayer=1, Sentinel=1, Refugee=1, PDC=1, MADS=1, Lifeline=1, Hallucinator=1, Governor=1, FAST_point=1, Barrier=1, Administrator=1}
for i = 1, 11 do EXCLUDED_NPCS["dead guy " .. i] = 1 end

local cachedWeapon, validNPCs, lastFindTime = nil, {}, 0
local currentTarget, lastAttackTime, attackCount = nil, 0, 0

-- Debug UI elements
local debugLabel, targetLabel, statsLabel

local findValidTargets = function()
    local char, targets = LocalPlayer.Character, {}
    if not char then return targets end
    
    local children = workspace:GetChildren()
    for i = 1, #children do
        local model = children[i]
        if model:IsA("Model") and not EXCLUDED_NPCS[model.Name] and not Players:GetPlayerFromCharacter(model) then
            local humanoid = model:FindFirstChildOfClass("Humanoid")
            if model.Name == "APU" then
                local pilot = model:FindFirstChild("Pilot")
                humanoid = pilot and pilot:FindFirstChildOfClass("Humanoid")
            elseif model.Name == "Platform" then
                local modelChildren = model:GetChildren()
                for j = 1, #modelChildren do
                    local child = modelChildren[j]
                    if child.Name:match("Emplacement%d") then
                        local h = child:FindFirstChildOfClass("Humanoid")
                        if h and h.Health > 0 then targets[#targets + 1] = {model = model, target = h} end
                    end
                end
                if #targets == 0 and humanoid and humanoid.Health > 0 then
                    targets[#targets + 1] = {model = model, target = humanoid}
                end
                humanoid = nil
            end
            if humanoid and humanoid.Health > 0 then
                targets[#targets + 1] = {model = model, target = humanoid, priority = model.Name == "Drone"}
            end
        end
    end
    table.sort(targets, function(a, b) return (a.priority or false) and not (b.priority or false) end)
    return targets
end

local attack = function(npc)
    -- Update target info
    if npc ~= currentTarget then
        currentTarget = npc
        attackCount = 0
        if targetLabel then
            targetLabel.Text = "Target: " .. (npc.model.Name or "Unknown")
        end
    end
    
    -- Cache weapon if needed
    if not cachedWeapon or not cachedWeapon.Parent then
        local char, backpack = LocalPlayer.Character, LocalPlayer:FindFirstChild("Backpack")
        for _, loc in ipairs({char, backpack}) do
            if loc then
                local items = loc:GetChildren()
                for i = 1, #items do
                    local item = items[i]
                    if item:IsA("Tool") and (item:GetAttribute("Class") == "Melee" or item.Name == "Shovel") then
                        local verify = item:FindFirstChild("VerifyHit")
                        if verify and verify:IsA("RemoteEvent") then 
                            cachedWeapon = item
                            break
                        end
                    end
                end
            end
            if cachedWeapon then break end
        end
    end
    
    -- Attack if we have a valid weapon and target
    if cachedWeapon and npc.target and npc.target.Parent then
        local verify = cachedWeapon:FindFirstChild("VerifyHit")
        if verify then 
            attackCount = attackCount + 1
            lastAttackTime = tick()
            
            verify:FireServer(npc.target, ("%04x%04x-%04x-%04x-%04x-%04x%08x"):format(
                math.random(0, 0xffff), math.random(0, 0xffff), math.random(0, 0xffff),
                bit32.bor(0x4000, math.random(0, 0x0fff)), bit32.bor(0x8000, math.random(0, 0x3fff)),
                math.random(0, 0xffff), math.random(0, 0xffffffff)))
                
            -- Update debug info
            if statsLabel then
                local timeSinceLast = tick() - lastAttackTime
                statsLabel.Text = "Attacks: " .. attackCount .. " | Last: " .. string.format("%.3f", timeSinceLast) .. "s"
            end
        else
            if debugLabel then debugLabel.Text = "DEBUG: No VerifyHit found" end
        end
    else
        if debugLabel then 
            debugLabel.Text = "DEBUG: Missing weapon or target"
        end
    end
end

-- Main loop
task.spawn(function()
    while true do
        if CONFIG.enabled then
            -- Refresh NPC cache periodically
            local currentTime = tick()
            if currentTime - lastFindTime > CONFIG.npcCacheRefreshRate then
                validNPCs = findValidTargets()
                lastFindTime = currentTime
                if isMobile and _G.npcCountLabel then 
                    _G.npcCountLabel.Text = "NPCs: " .. #validNPCs 
                end
            end
            
            -- Attack all valid NPCs
            if #validNPCs > 0 then
                for i = 1, #validNPCs do 
                    task.spawn(attack, validNPCs[i]) 
                end
            else
                if debugLabel then debugLabel.Text = "DEBUG: No valid targets" end
            end
            
            -- Check for stuck condition
            local timeSinceLastAttack = tick() - lastAttackTime
            if timeSinceLastAttack > 5 and currentTarget then
                if debugLabel then 
                    debugLabel.Text = "DEBUG: Stuck on " .. (currentTarget.model.Name or "Unknown") .. " for " .. string.format("%.1f", timeSinceLastAttack) .. "s"
                end
            end
        end
        task.wait(CONFIG.attackLoopWaitTime)
    end
end)

-- UI Setup
if isMobile then
    local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
    gui.Name, gui.ResetOnSpawn = "KillauraUI", false
    
    local btn = Instance.new("TextButton", gui)
    btn.Size, btn.Position = UDim2.fromOffset(100, 100), UDim2.fromOffset(10, 290)
    btn.BackgroundColor3, btn.Text, btn.TextColor3 = Color3.fromRGB(200, 50, 50), "KILL\nOFF", Color3.new(1, 1, 1)
    btn.Font, btn.TextSize, btn.BorderSizePixel = Enum.Font.GothamBold, 14, 0
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
    
    local lbl = Instance.new("TextLabel", gui)
    lbl.Size, lbl.Position = UDim2.fromOffset(100, 50), UDim2.fromOffset(10, 400)
    lbl.BackgroundColor3, lbl.Text, lbl.TextColor3 = Color3.fromRGB(30, 30, 30), "NPCs: 0", Color3.new(1, 1, 1)
    lbl.Font, lbl.TextSize, lbl.BackgroundTransparency = Enum.Font.Gotham, 12, 0.3
    Instance.new("UICorner", lbl).CornerRadius = UDim.new(0, 10)
    _G.npcCountLabel = lbl
    
    -- Debug labels
    debugLabel = Instance.new("TextLabel", gui)
    debugLabel.Size, debugLabel.Position = UDim2.fromOffset(200, 30), UDim2.fromOffset(10, 460)
    debugLabel.BackgroundColor3, debugLabel.Text, debugLabel.TextColor3 = Color3.fromRGB(50, 50, 50), "DEBUG: Ready", Color3.new(1, 1, 1)
    debugLabel.Font, debugLabel.TextSize, debugLabel.BackgroundTransparency = Enum.Font.Gotham, 10, 0.3
    Instance.new("UICorner", debugLabel).CornerRadius = UDim.new(0, 5)
    
    targetLabel = Instance.new("TextLabel", gui)
    targetLabel.Size, targetLabel.Position = UDim2.fromOffset(200, 30), UDim2.fromOffset(10, 500)
    targetLabel.BackgroundColor3, targetLabel.Text, targetLabel.TextColor3 = Color3.fromRGB(50, 50, 50), "Target: None", Color3.new(1, 1, 1)
    targetLabel.Font, targetLabel.TextSize, targetLabel.BackgroundTransparency = Enum.Font.Gotham, 10, 0.3
    Instance.new("UICorner", targetLabel).CornerRadius = UDim.new(0, 5)
    
    statsLabel = Instance.new("TextLabel", gui)
    statsLabel.Size, statsLabel.Position = UDim2.fromOffset(200, 30), UDim2.fromOffset(10, 540)
    statsLabel.BackgroundColor3, statsLabel.Text, statsLabel.TextColor3 = Color3.fromRGB(50, 50, 50), "Attacks: 0 | Last: 0.000s", Color3.new(1, 1, 1)
    statsLabel.Font, statsLabel.TextSize, statsLabel.BackgroundTransparency = Enum.Font.Gotham, 10, 0.3
    Instance.new("UICorner", statsLabel).CornerRadius = UDim.new(0, 5)
    
    btn.Activated:Connect(function()
        CONFIG.enabled = not CONFIG.enabled
        btn.Text = CONFIG.enabled and "KILL\nON" or "KILL\nOFF"
        btn.BackgroundColor3 = CONFIG.enabled and Color3.fromRGB(76, 175, 80) or Color3.fromRGB(200, 50, 50)
        if debugLabel then debugLabel.Text = "DEBUG: " .. (CONFIG.enabled and "Enabled" or "Disabled") end
    end)
else
    UserInputService.InputBegan:Connect(function(input, proc)
        if not proc and input.KeyCode == Enum.KeyCode.Z then
            CONFIG.enabled = not CONFIG.enabled
            print("Killaura", CONFIG.enabled and "Enabled" or "Disabled")
        end
    end)
end

print("Killaura loaded" .. (isMobile and " (Mobile)" or "") .. " with debugging")
